<!DOCTYPE html>
<html class="no-js" data-ng-app="cdApp">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF8">
<title>Crossfilter</title>
<link rel="stylesheet" href="//code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/dc/1.7.0/dc.css">
<style>

</style>
</head>
<body>

<h1>Citibike Data</h1>


<div id="chart">
    <a class="reset" href="javascript:myChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
</div>

<aside id="totals"><span id="active">-</span> of <span id="total">-</span> flights selected.</aside>

<div id="lists">
  <div id="bike-list" class="list"></div>
</div>


</div>
<div id="chart-line-hitsperday"></div>

<div style='clear:both;'>
    <table id="dc-data-table">
      <thead>
      <tr class="header">
        <th>Start Date</th>
        <th>Start Station</th>
        <th>End Station</th>
        <th>Trip Duration</th>
        <th>Gender</th>
      </tr>
      </thead>
    </table>
</div> 


<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.7/crossfilter.min.js"></script>
<script src="http://dc-js.github.io/dc.js/js/dc.js"></script>

<!-- anchor div for data table -->

    
<script>

//request data from server
d3.xhr("/next_data", function(error, bikeresp) {
  console.log(bikeresp);
  console.log(bikeresp.response);
  bikedata = JSON.parse ( bikeresp.response );
  var parseDate = d3.time.format("%m/%d/%Y").parse;
  //bikedata = bikeresp.response;
  bikedata.forEach(function (d) {
        d.startdate = new Date(d.start);
        d.enddate = new Date(d.end);
        d.month = d3.time.month(d.startdate);
    });
  window.data = bikedata;
  console.log(bikedata);
  //bikedata = JSON.parse( bikestring );
  //headers = bikedata[]
  // Various formatters.
  var formatNumber = d3.format(",d"),
      formatChange = d3.format("+,d"),
      formatDate = d3.time.format("%B %d, %Y"),
      formatTime = d3.time.format("%I:%M %p");

  // A nest operator, for grouping the flight list.
  var nestByDate = d3.nest()
      .key(function(d) { return d3.time.day(d.startdate); });

  // A little coercion, since the CSV is untyped.
  //bikedata.forEach(function(d, i) {
  //  d.index = i;
  //  d.date = parseDate(d.date);
  //});

  // Create the crossfilter for the relevant dimensions and groups.
  var bike = crossfilter(bikedata);
  var all = bike.groupAll();
  var date = bike.dimension(function(d) { return d.startdate; });
  var dates = date.group(d3.time.day);
  //var hour = bike.dimension(function(d) { return formatTime(new Date(d.start)); })
  //var hours = hour.group(d3.time.hour);
  var gender = bike.dimension(function(d) { return d.gender; });
  var startstation = bike.dimension(function(d) {return d.startstationname; });
  var endstation = bike.dimension(function(d) {return d.endstationname; });

  var dayOfWeek = bike.dimension(function (d) {
        var day = d.startdate.getDay();
        var name=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
        return day+"."+name[day];
    });
  var dayOfWeekGroup = dayOfWeek.group();

  console.log("did that");
  console.log(bike);
  console.log(dates);

  console.log("-- group by date");
    dates.top(Infinity).forEach(function(p, i) {
      console.log(p.key + ": " + p.value);
    });
    console.log("");
  console.log("-- group by start");
    var groupByStart = startstation.group();
    groupByStart.top(Infinity).forEach(function(p, i) {
      console.log(p.key + ": " + p.value);
    });
    console.log("");
  console.log("-- group by end");
    var groupByEnd = endstation.group();
    groupByEnd.top(Infinity).forEach(function(p, i) {
      console.log(p.key + ": " + p.value);
    });
    console.log("");


  var hits = date.group().reduceSum(dc.pluck('tripduration')); 
  var minDate = date.bottom(1)[0].startdate;
  var maxDate = date.top(1)[0].startdate;
  var hitslineChart  = dc.lineChart("#chart-line-hitsperday"); 
  //var dataTable =  dc.dataTable(".dc-data-table");
  var dataTable =  dc.dataTable("#dc-data-table");

  hitslineChart
    .width(500).height(200)
    .dimension(date)
    .group(hits)
    .x(d3.time.scale().domain([minDate,maxDate])); 

  dataTable
        .dimension(date)
        .group(function (d) {
            return d.month;
        })
        .size(10) // (optional) max number of records to be shown, :default = 25
        .columns([
            function (d) {
                return d.startdate;
            },
            function (d) {
                return d.startstationname;
            },
            function (d) {
                return d.endstationname;
            },
            function (d) {
                return d.tripduration;
            },
            function (d) {
                return d.gender;
            }
        ])
        .sortBy(function (d) {
            return d.startdate;
        })
        .order(d3.ascending)
        .renderlet(function (table) {
            table.selectAll(".dc-table-group").classed("info", true);
        });
        console.log("doing stuff");

        dc.renderAll();
        console.log("doing stuff 2");
        dc.redrawAll();
        console.log("doing stuff 3");



});

</script>


</body>

